From 3226de614dd72868662cdc0e11b8cd8aa3fecb69 Mon Sep 17 00:00:00 2001
From: Ben Pfaff <blp@ovn.org>
Date: Mon, 25 Jun 2018 13:07:43 -0700
Subject: [PATCH 3/3] ofp-actions: Avoid buffer overread in BUNDLE action
 decoding.

Upstream status: backport(https://github.com/openvswitch/ovs/commit/9237a63c47bd)
CVE: CVE-2018-17206

Reported-at: https://bugs.chromium.org/p/oss-fuzz/issues/detail?id=9052
Signed-off-by: Ben Pfaff <blp@ovn.org>
Acked-by: Justin Pettit <jpettit@ovn.org>
Signed-off-by: Anand Je Sypureddy <anandje@mvista.com>
---
 lib/ofp-actions.c | 13 +++++++------
 1 file changed, 7 insertions(+), 6 deletions(-)

diff --git a/lib/ofp-actions.c b/lib/ofp-actions.c
index bfc8a80..799d37f 100644
--- a/lib/ofp-actions.c
+++ b/lib/ofp-actions.c
@@ -1388,12 +1388,13 @@ decode_bundle(bool load, const struct nx_action_bundle *nab,
                      load ? "bundle_load" : "bundle", slaves_size,
                      bundle->n_slaves * sizeof(ovs_be16), bundle->n_slaves);
         error = OFPERR_OFPBAC_BAD_LEN;
-    }
-
-    for (i = 0; i < bundle->n_slaves; i++) {
-        ofp_port_t ofp_port = u16_to_ofp(ntohs(((ovs_be16 *)(nab + 1))[i]));
-        ofpbuf_put(ofpacts, &ofp_port, sizeof ofp_port);
-        bundle = ofpacts->header;
+    } else {
+        for (i = 0; i < bundle->n_slaves; i++) {
+            ofp_port_t ofp_port
+                = u16_to_ofp(ntohs(((ovs_be16 *)(nab + 1))[i]));
+            ofpbuf_put(ofpacts, &ofp_port, sizeof ofp_port);
+            bundle = ofpacts->header;
+        }
     }
 
     ofpact_finish_BUNDLE(ofpacts, &bundle);
-- 
2.7.4

